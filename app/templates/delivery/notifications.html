{% extends "delivery/delivery_base.html" %}

{% block title %}Notifications - Delivery Agent{% endblock %}

{% block delivery_content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-bell text-primary"></i> My Notifications</h2>
            <div class="d-flex gap-2">
                <!-- Sound Controls -->
                <div class="btn-group me-3">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="soundToggleBtn" title="Toggle notification sounds">
                        <i class="fas fa-volume-up" id="soundIcon"></i>
                    </button>
                </div>
                <!-- Filter Controls -->
                <div class="btn-group">
                    <a href="{{ url_for('delivery.notifications', filter='all') }}" class="btn btn-sm {{ 'btn-primary' if filter_by == 'all' else 'btn-outline-primary' }}">All</a>
                    <a href="{{ url_for('delivery.notifications', filter='unread') }}" class="btn btn-sm {{ 'btn-primary' if filter_by == 'unread' else 'btn-outline-primary' }}">Unread</a>
                    <a href="{{ url_for('delivery.notifications', filter='read') }}" class="btn btn-sm {{ 'btn-primary' if filter_by == 'read' else 'btn-outline-primary' }}">Read</a>
                </div>
            </div>
        </div>

        <!-- Notification Statistics -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-body">
                        <i class="fas fa-bell fa-2x mb-2" style="color: rgba(255,255,255,0.9);"></i>
                        <h4 class="mb-0">{{ total_count or 0 }}</h4>
                        <small style="color: rgba(255,255,255,0.8);">Total Notifications</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center text-white" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
                    <div class="card-body">
                        <i class="fas fa-envelope fa-2x mb-2" style="color: rgba(255,255,255,0.9);"></i>
                        <h4 class="mb-0">{{ unread_count or 0 }}</h4>
                        <small style="color: rgba(255,255,255,0.8);">Unread Notifications</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center text-white" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="card-body">
                        <i class="fas fa-box fa-2x mb-2" style="color: rgba(255,255,255,0.9);"></i>
                        <h4 class="mb-0">{{ (recent_orders|length) or 0 }}</h4>
                        <small class="text-muted">Recent Orders</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        {% if unread_count and unread_count > 0 %}
        <div class="alert alert-info">
            <div class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-info-circle"></i> You have {{ unread_count }} unread notification{{ 's' if unread_count != 1 }}.</span>
                <button class="btn btn-sm btn-outline-primary" onclick="markAllAsRead()">
                    <i class="fas fa-check-double"></i> Mark All as Read
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Notifications List -->
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
            <div class="card-header" style="background: rgba(255,255,255,0.1); border-bottom: 1px solid rgba(255,255,255,0.2);">
                <h5 class="mb-0 text-white">
                    <i class="fas fa-list"></i> 
                    {% if filter_by == 'unread' %}Unread Notifications
                    {% elif filter_by == 'read' %}Read Notifications
                    {% else %}All Notifications{% endif %}
                </h5>
            </div>
            <div class="card-body p-0">
                {% if notifications %}
                    <div class="list-group list-group-flush">
                        {% for notification in notifications %}
                        <div class="list-group-item d-flex align-items-center py-3 {{ 'border-bottom border-light' if not loop.last }}" 
                             style="background: rgba(255,255,255,{{ '0.15' if not notification.is_read else '0.05' }}); border: none;"
                             data-notification-id="{{ notification.id }}">
                            <div class="flex-shrink-0 me-3">
                                {% if notification.type == 'order_assignment' %}
                                    <div class="notification-icon" style="background: linear-gradient(135deg, #007bff, #0056b3);">
                                        <i class="fas fa-truck text-white"></i>
                                    </div>
                                {% elif notification.type == 'order_update' %}
                                    <div class="notification-icon" style="background: linear-gradient(135deg, #17a2b8, #117a8b);">
                                        <i class="fas fa-info-circle text-white"></i>
                                    </div>
                                {% elif notification.type == 'payment' %}
                                    <div class="notification-icon" style="background: linear-gradient(135deg, #28a745, #1e7e34);">
                                        <i class="fas fa-money-bill text-white"></i>
                                    </div>
                                {% else %}
                                    <div class="notification-icon" style="background: linear-gradient(135deg, #6c757d, #495057);">
                                        <i class="fas fa-bell text-white"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1 fw-semibold text-white">
                                            {% if notification.type == 'order_assignment' %}
                                                New Delivery Assignment
                                            {% elif notification.type == 'order_update' %}
                                                Order Status Update
                                            {% elif notification.type == 'payment' %}
                                                Payment Notification
                                            {% else %}
                                                System Notification
                                            {% endif %}
                                            {% if not notification.is_read %}
                                                <span class="badge bg-danger ms-2">New</span>
                                            {% endif %}
                                        </h6>
                                        <p class="mb-1" style="color: rgba(255,255,255,0.8);">{{ notification.content }}</p>
                                        <small style="color: rgba(255,255,255,0.6);">
                                            <i class="fas fa-clock me-1"></i>
                                            {% if notification.created_at %}
                                                {{ notification.created_at.strftime('%m/%d/%Y at %I:%M %p') }}
                                            {% else %}
                                                {{ notification.timestamp or 'Unknown time' }}
                                            {% endif %}
                                        </small>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            {% if not notification.is_read %}
                                            <li><a class="dropdown-item" href="#" onclick="markAsRead({{ notification.id }})">
                                                <i class="fas fa-check me-1"></i> Mark as Read
                                            </a></li>
                                            {% endif %}
                                            {% if notification.related_order_id %}
                                            <li><a class="dropdown-item" href="{{ url_for('delivery.order_detail', order_id=notification.related_order_id) }}">
                                                <i class="fas fa-eye me-1"></i> View Order
                                            </a></li>
                                            {% elif notification.link %}
                                            <li><a class="dropdown-item" href="{{ notification.link }}">
                                                <i class="fas fa-eye me-1"></i> View Details
                                            </a></li>
                                            {% endif %}
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteNotification({{ notification.id }})">
                                                <i class="fas fa-trash me-1"></i> Delete
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-bell-slash fa-4x mb-3" style="color: rgba(255,255,255,0.6);"></i>
                        <h4 style="color: rgba(255,255,255,0.9);">No Notifications</h4>
                        <p style="color: rgba(255,255,255,0.7);">
                            {% if filter_by == 'unread' %}
                                You have no unread notifications at the moment.
                            {% elif filter_by == 'read' %}
                                No read notifications to display.
                            {% else %}
                                You'll see new delivery assignments and updates here.
                            {% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Pagination -->
        {% if notifications and notifications.pages and notifications.pages > 1 %}
        <nav aria-label="Notifications pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if notifications.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('delivery.notifications', filter=filter_by, page=notifications.prev_num) }}">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                </li>
                {% endif %}
                
                {% for page_num in notifications.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != notifications.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('delivery.notifications', filter=filter_by, page=page_num) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if notifications.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('delivery.notifications', filter=filter_by, page=notifications.next_num) }}">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Toast notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="actionToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-check-circle text-success me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="actionToastBody">
            Action completed successfully.
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.stat-card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.notification-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.list-group-item:hover {
    background-color: rgba(0,123,255,0.05) !important;
}

.bg-light {
    background-color: rgba(0,123,255,0.05) !important;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

function markAsRead(notificationId) {
    fetch(`/delivery/notifications/${notificationId}/mark-read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Notification marked as read');
            location.reload();
        } else {
            showToast('Error marking notification as read', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error marking notification as read', 'error');
    });
}

function markAllAsRead() {
    if (confirm('Mark all notifications as read?')) {
        fetch('/delivery/notifications/mark-all-read', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('All notifications marked as read');
                location.reload();
            } else {
                showToast('Error marking notifications as read', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error marking notifications as read', 'error');
        });
    }
}

function deleteNotification(notificationId) {
    if (confirm('Are you sure you want to delete this notification?')) {
        const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
        
        fetch(`/delivery/notifications/${notificationId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('Notification deleted successfully', 'success');
                // Remove the notification element from DOM
                const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
                if (notificationElement) {
                    notificationElement.remove();
                } else {
                    location.reload(); // Fallback to page reload
                }
            } else {
                showToast(data.error || 'Error deleting notification', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error deleting notification', 'error');
        });
    }
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('actionToast');
    const toastBody = document.getElementById('actionToastBody');
    const toastHeader = toast.querySelector('.toast-header');
    
    toastBody.textContent = message;
    
    if (type === 'error') {
        toastHeader.innerHTML = '<i class="fas fa-exclamation-circle text-danger me-2"></i><strong class="me-auto">Error</strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button>';
    } else {
        toastHeader.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i><strong class="me-auto">Success</strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button>';
    }
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Auto-refresh notifications every 60 seconds
setInterval(function() {
    // Optional: Add subtle notification check without full reload
    fetch('/delivery/notifications/check-new')
        .then(response => response.json())
        .then(data => {
            if (data.has_new) {
                // Update notification badge in sidebar
                const badge = document.querySelector('.notification-badge');
                if (badge) badge.textContent = data.unread_count;
            }
        })
        .catch(error => console.log('Background notification check failed'));
}, 60000);

// Sound toggle functionality
document.getElementById('soundToggleBtn').addEventListener('click', function() {
    const soundIcon = document.getElementById('soundIcon');
    const currentlyMuted = localStorage.getItem('deliveryNotificationsMuted') === 'true';
    
    if (currentlyMuted) {
        // Unmute
        localStorage.setItem('deliveryNotificationsMuted', 'false');
        soundIcon.className = 'fas fa-volume-up';
        this.title = 'Mute notification sounds';
        showToast('Notification sounds enabled', 'success');
    } else {
        // Mute
        localStorage.setItem('deliveryNotificationsMuted', 'true');
        soundIcon.className = 'fas fa-volume-mute';
        this.title = 'Unmute notification sounds';
        showToast('Notification sounds muted', 'info');
    }
});

// Initialize sound toggle state
document.addEventListener('DOMContentLoaded', function() {
    const soundIcon = document.getElementById('soundIcon');
    const soundBtn = document.getElementById('soundToggleBtn');
    const isMuted = localStorage.getItem('deliveryNotificationsMuted') === 'true';
    
    if (isMuted) {
        soundIcon.className = 'fas fa-volume-mute';
        soundBtn.title = 'Unmute notification sounds';
    } else {
        soundIcon.className = 'fas fa-volume-up';
        soundBtn.title = 'Mute notification sounds';
    }
});

</script>
{% endblock %}