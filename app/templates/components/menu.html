{% extends "base.html" %}

{% block title %}Menu - BhojanXpress{% endblock %}

{% block head %}
{{ super() }}
<link href="{{ url_for('static', filename='css/search.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Filters (Flipkart Style) -->
        <div class="col-lg-3 col-md-4 mb-4" id="filterSidebar">
            <div class="filter-sidebar bg-white shadow-sm rounded p-4 position-sticky" style="top: 20px;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="fw-bold mb-0">Filters</h4>
                    <button class="btn btn-sm btn-outline-secondary d-lg-none" id="hideFiltersBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Price Filter -->
                <div class="filter-section mb-4">
                    <h5 class="filter-title d-flex justify-content-between align-items-center">
                        <span>PRICE</span>
                        <button class="btn btn-link btn-sm text-primary p-0" onclick="clearPriceFilter()">CLEAR</button>
                    </h5>
                    
                    <!-- Price Range Slider -->
                    <div class="price-slider-container my-3">
                        <div class="d-flex justify-content-between mt-2">
                            <select class="form-select form-select-sm" id="minPriceSelect" style="width: 45%;" onchange="autoApplyFilters()">
                                <option value="">Min</option>
                                <option value="0">₹0</option>
                                <option value="50">₹50</option>
                                <option value="100">₹100</option>
                                <option value="200">₹200</option>
                                <option value="300">₹300</option>
                                <option value="500">₹500</option>
                            </select>
                            <span class="align-self-center mx-2">to</span>
                            <select class="form-select form-select-sm" id="maxPriceSelect" style="width: 45%;" onchange="autoApplyFilters()">
                                <option value="">Max</option>
                                <option value="100">₹100</option>
                                <option value="200">₹200</option>
                                <option value="300">₹300</option>
                                <option value="500">₹500</option>
                                <option value="1000">₹1000</option>
                                <option value="2000">₹2000+</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="filter-section mb-4">
                    <h5 class="filter-title">CATEGORY</h5>
                    <div class="category-filters">
                        <div class="form-check mb-2">
                            <input class="form-check-input category-filter" type="radio" name="categoryFilter" id="categoryAll" value="all" {% if not current_category or current_category == 'all' %}checked{% endif %} onchange="autoApplyFilters()">
                            <label class="form-check-label" for="categoryAll">
                                All Categories
                            </label>
                        </div>
                        {% if categories %}
                        {% for category in categories %}
                        <div class="form-check mb-2">
                            <input class="form-check-input category-filter" type="radio" name="categoryFilter" id="category{{ loop.index }}" value="{{ category.name }}" {% if current_category == category.name %}checked{% endif %} onchange="autoApplyFilters()">
                            <label class="form-check-label" for="category{{ loop.index }}">
                                {{ category.display_name }}
                            </label>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Filter Actions -->
                <div class="filter-actions mt-4">
                    <button class="btn btn-outline-secondary w-100" onclick="clearAllFilters()">
                        <i class="fas fa-times me-2"></i>Clear All
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-8" id="mainContent">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <div class="d-flex align-items-center">
                        <h2 class="fw-bold mb-1 me-3">Our Menu</h2>
                        <!-- Show/Hide Filter Button (Mobile) -->
                        <button class="btn btn-outline-primary btn-sm d-lg-none" id="showFiltersBtn">
                            <i class="fas fa-filter me-2"></i>Filters
                        </button>
                    </div>
                    <p class="text-muted mb-0">
                        {% if current_category and current_category != 'all' %}
                            {{ current_category.replace('_', ' ').title() }} - 
                        {% endif %}
                        {% if food_items.items %}
                            Showing {{ food_items.items|length }} item{{ 's' if food_items.items|length != 1 else '' }}
                        {% else %}
                            No items available
                        {% endif %}
                    </p>
                </div>
                
                <!-- Sort Options -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown">
                        <i class="fas fa-sort me-2"></i><span id="sortLabel">Sort by</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item sort-option" href="#" data-sort="relevance">
                            <i class="fas fa-star me-2"></i>Relevance
                        </a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="name">
                            <i class="fas fa-sort-alpha-down me-2"></i>Name (A-Z)
                        </a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="name-desc">
                            <i class="fas fa-sort-alpha-up me-2"></i>Name (Z-A)
                        </a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="price-low">
                            <i class="fas fa-arrow-up me-2"></i>Price: Low to High
                        </a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="price-high">
                            <i class="fas fa-arrow-down me-2"></i>Price: High to Low
                        </a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="newest">
                            <i class="fas fa-clock me-2"></i>Newest First
                        </a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="rating">
                            <i class="fas fa-star me-2"></i>Highest Rated
                        </a></li>
                    </ul>
                </div>
            </div>

            <!-- Active Filters Display -->
            <div id="activeFilters" class="mb-3" style="display: none;">
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <span class="fw-bold text-muted">Active Filters:</span>
                    <div id="activeFilterTags"></div>
                    <button class="btn btn-link btn-sm text-danger p-0 ms-2" onclick="clearAllFilters()">
                        Clear All
                    </button>
                </div>
            </div>

            <!-- Food Items Grid -->
            {% if food_items.items %}
            <div class="row g-4" id="foodItemsContainer">
                {% for item in food_items.items %}
                <div class="col-xl-4 col-lg-6 col-md-6 food-item" 
                     data-category="{{ item.category }}" 
                     data-price="{{ item.price }}" 
                     data-available="{{ item.is_available|string|lower }}">
                    <div class="card h-100 shadow-sm food-item-card rounded-3 border-0 transition-all">
                        <!-- Food Image -->
                        <a href="{{ url_for('user.food_detail', food_id=item.id) }}" class="position-relative">
                            {% if item.image_url %}
                            <img src="{{ item.image_url }}" class="card-img-top food-image rounded-top-3" alt="{{ item.name }}" loading="lazy" style="height: 200px; object-fit: cover;">
                            {% else %}
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center food-image-placeholder rounded-top-3" style="height: 200px;">
                                <i class="fas fa-utensils text-muted fa-2x"></i>
                            </div>
                            {% endif %}

                            <!-- Status badge -->
                            <span class="position-absolute top-0 end-0 m-2 badge {% if item.is_available %}bg-success{% else %}bg-danger{% endif %} rounded-pill">
                                {% if item.is_available %}Available{% else %}Sold Out{% endif %}
                            </span>
                        </a>

                        <!-- Card Body -->
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <a href="{{ url_for('user.food_detail', food_id=item.id) }}" class="text-decoration-none text-dark">
                                    <h5 class="card-title mb-0 text-truncate">{{ item.name }}</h5>
                                </a>
                                <span class="badge bg-info text-white ms-2">{{ item.preparation_time or 15 }}min</span>
                            </div>
                            
                            <p class="card-text text-muted small">{{ item.description[:100] }}{% if item.description|length > 100 %}...{% endif %}</p>
                            
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="h5 text-success mb-0">₹{{ "%.2f"|format(item.price) }}</span>
                                    <span class="badge bg-secondary">{{ item.category.replace('_', ' ').title() if item.category else 'General' }}</span>
                                </div>
                                
                                {% if current_user.is_authenticated %}
                                {% if item.is_available %}
                                <button class="btn btn-primary w-100" onclick="addToCart({{ item.id }})">
                                    <i class="fas fa-cart-plus me-1"></i> Add to Cart
                                </button>
                                {% else %}
                                <button class="btn btn-secondary w-100" disabled>
                                    <i class="fas fa-times me-1"></i> Unavailable
                                </button>
                                {% endif %}
                                {% else %}
                                <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-sign-in-alt me-1"></i> Login to Order
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No food items available in this category.
                </div>
                <a href="{{ url_for('user.menu') }}" class="btn btn-primary">View All Items</a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Pagination -->
    {% if food_items.pages > 1 %}
    <nav aria-label="Menu pagination" class="mt-5">
        <ul class="pagination justify-content-center">
            {% if food_items.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('user.menu', page=food_items.prev_num, category=current_category) }}">Previous</a>
            </li>
            {% endif %}

            {% for page_num in food_items.iter_pages() %}
                {% if page_num %}
                    {% if page_num != food_items.page %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('user.menu', page=page_num, category=current_category) }}">{{ page_num }}</a>
                    </li>
                    {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% endif %}
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
                {% endif %}
            {% endfor %}

            {% if food_items.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('user.menu', page=food_items.next_num, category=current_category) }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

</div>

<script>
// Menu Filter and Sort Functionality
let allItems = [];
let filteredItems = [];

document.addEventListener('DOMContentLoaded', function() {
    // Store all items for filtering
    const foodItems = document.querySelectorAll('.food-item');
    allItems = Array.from(foodItems);
    filteredItems = [...allItems];
    
    // Initialize event listeners
    initializeEventListeners();
});

function initializeEventListeners() {
    // Show/Hide Filter Buttons
    const showFiltersBtn = document.getElementById('showFiltersBtn');
    const hideFiltersBtn = document.getElementById('hideFiltersBtn');
    const filterSidebar = document.getElementById('filterSidebar');
    
    if (showFiltersBtn) {
        showFiltersBtn.addEventListener('click', function() {
            filterSidebar.style.display = 'block';
            filterSidebar.classList.add('mobile-filter-show');
        });
    }
    
    if (hideFiltersBtn) {
        hideFiltersBtn.addEventListener('click', function() {
            filterSidebar.style.display = 'none';
            filterSidebar.classList.remove('mobile-filter-show');
        });
    }
    
    // Sort dropdown
    const sortOptions = document.querySelectorAll('.sort-option');
    sortOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const sortType = this.getAttribute('data-sort');
            const sortLabel = this.textContent.trim();
            document.getElementById('sortLabel').textContent = sortLabel;
            sortItems(sortType);
        });
    });
    
    // Category filters with auto-apply
    const categoryFilters = document.querySelectorAll('.category-filter');
    categoryFilters.forEach(filter => {
        filter.addEventListener('change', function() {
            if (this.checked) {
                updateActiveFilters();
                applyFilters();
            }
        });
    });
    
    // Price filters
    const minPriceSelect = document.getElementById('minPriceSelect');
    const maxPriceSelect = document.getElementById('maxPriceSelect');
    
    if (minPriceSelect) {
        minPriceSelect.addEventListener('change', function() {
            updateActiveFilters();
        });
    }
    
    if (maxPriceSelect) {
        maxPriceSelect.addEventListener('change', function() {
            updateActiveFilters();
        });
    }
    
    // Availability filters
    const availableOnly = document.getElementById('availableOnly');
    const includeOutOfStock = document.getElementById('includeOutOfStock');
    
    if (availableOnly) {
        availableOnly.addEventListener('change', updateActiveFilters);
    }
    
    if (includeOutOfStock) {
        includeOutOfStock.addEventListener('change', updateActiveFilters);
    }
}

function applyFilters() {
    const category = document.querySelector('input[name="categoryFilter"]:checked')?.value || 'all';
    const minPrice = parseFloat(document.getElementById('minPriceSelect')?.value) || 0;
    const maxPrice = parseFloat(document.getElementById('maxPriceSelect')?.value) || Infinity;
    const availableOnly = document.getElementById('availableOnly')?.checked || false;
    const includeOutOfStock = document.getElementById('includeOutOfStock')?.checked || false;
    
    filteredItems = allItems.filter(item => {
        // Category filter
        const itemCategory = item.getAttribute('data-category');
        if (category !== 'all' && itemCategory !== category) {
            return false;
        }
        
        // Price filter
        const itemPrice = parseFloat(item.getAttribute('data-price'));
        if (itemPrice < minPrice || itemPrice > maxPrice) {
            return false;
        }
        
        // Availability filter
        const itemAvailable = item.getAttribute('data-available') === 'true';
        if (availableOnly && !itemAvailable) {
            return false;
        }
        
        if (!includeOutOfStock && !itemAvailable) {
            return false;
        }
        
        return true;
    });
    
    // Hide all items first
    allItems.forEach(item => {
        item.style.display = 'none';
    });
    
    // Show filtered items
    filteredItems.forEach(item => {
        item.style.display = 'block';
    });
    
    // Update results count
    updateResultsCount();
    
    // Update active filters display
    updateActiveFilters();
    
    // Hide filter sidebar on mobile after applying
    const filterSidebar = document.getElementById('filterSidebar');
    if (window.innerWidth < 992) {
        filterSidebar.style.display = 'none';
    }
}

function sortItems(sortType) {
    const container = document.getElementById('foodItemsContainer');
    
    filteredItems.sort((a, b) => {
        switch (sortType) {
            case 'name':
                return a.querySelector('.card-title').textContent.localeCompare(b.querySelector('.card-title').textContent);
            
            case 'name-desc':
                return b.querySelector('.card-title').textContent.localeCompare(a.querySelector('.card-title').textContent);
            
            case 'price-low':
                return parseFloat(a.getAttribute('data-price')) - parseFloat(b.getAttribute('data-price'));
            
            case 'price-high':
                return parseFloat(b.getAttribute('data-price')) - parseFloat(a.getAttribute('data-price'));
            
            case 'newest':
                // Assume items are already in newest order in HTML
                return 0;
            
            case 'rating':
                // If rating data is available
                const ratingA = parseFloat(a.getAttribute('data-rating')) || 0;
                const ratingB = parseFloat(b.getAttribute('data-rating')) || 0;
                return ratingB - ratingA;
            
            default:
                return 0;
        }
    });
    
    // Re-append items in sorted order
    filteredItems.forEach(item => {
        container.appendChild(item);
    });
}

function updateActiveFilters() {
    const activeFiltersDiv = document.getElementById('activeFilters');
    const activeFilterTags = document.getElementById('activeFilterTags');
    const tags = [];
    
    // Category filter
    const selectedCategory = document.querySelector('input[name="categoryFilter"]:checked');
    if (selectedCategory && selectedCategory.value !== 'all') {
        tags.push({
            type: 'category',
            value: selectedCategory.value,
            label: selectedCategory.nextElementSibling.textContent.trim()
        });
    }
    
    // Price filters
    const minPrice = document.getElementById('minPriceSelect')?.value;
    const maxPrice = document.getElementById('maxPriceSelect')?.value;
    if (minPrice || maxPrice) {
        let priceLabel = 'Price: ';
        if (minPrice && maxPrice) {
            priceLabel += `₹${minPrice} - ₹${maxPrice}`;
        } else if (minPrice) {
            priceLabel += `₹${minPrice}+`;
        } else if (maxPrice) {
            priceLabel += `Up to ₹${maxPrice}`;
        }
        tags.push({
            type: 'price',
            label: priceLabel
        });
    }
    
    // Availability filters
    if (document.getElementById('availableOnly')?.checked) {
        tags.push({
            type: 'availability',
            label: 'Available Only'
        });
    }
    
    // Display tags
    if (tags.length > 0) {
        activeFilterTags.innerHTML = tags.map(tag => 
            `<span class="badge bg-primary me-2 mb-1">
                ${tag.label}
                <i class="fas fa-times ms-1 cursor-pointer" onclick="removeFilter('${tag.type}', '${tag.value || ''}')"></i>
            </span>`
        ).join('');
        activeFiltersDiv.style.display = 'block';
    } else {
        activeFiltersDiv.style.display = 'none';
    }
}

function removeFilter(type, value) {
    switch (type) {
        case 'category':
            document.getElementById('categoryAll').checked = true;
            break;
        case 'price':
            document.getElementById('minPriceSelect').value = '';
            document.getElementById('maxPriceSelect').value = '';
            break;
        case 'availability':
            document.getElementById('availableOnly').checked = false;
            break;
    }
    applyFilters();
}

function clearAllFilters() {
    // Reset all filter inputs
    document.getElementById('categoryAll').checked = true;
    document.getElementById('minPriceSelect').value = '';
    document.getElementById('maxPriceSelect').value = '';
    document.getElementById('availableOnly').checked = false;
    document.getElementById('includeOutOfStock').checked = false;
    
    // Apply filters (which will show all items)
    applyFilters();
}

function clearPriceFilter() {
    document.getElementById('minPriceSelect').value = '';
    document.getElementById('maxPriceSelect').value = '';
    updateActiveFilters();
}

function updateResultsCount() {
    const resultText = document.querySelector('.text-muted');
    if (resultText) {
        const count = filteredItems.length;
        const category = document.querySelector('input[name="categoryFilter"]:checked')?.nextElementSibling?.textContent || '';
        let newText = '';
        
        if (category && category !== 'All Categories') {
            newText = `${category} - `;
        }
        
        newText += `Showing ${count} item${count !== 1 ? 's' : ''}`;
        resultText.textContent = newText;
    }
}

// Add to Cart Function
function addToCart(itemId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Adding...';
    button.disabled = true;
    
    fetch(`/add_to_cart/${itemId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: new URLSearchParams({
            'quantity': '1'
        })
    })
    .then(response => response.json())
    .then(data => {
        button.innerHTML = originalText;
        button.disabled = false;
        
        if (data.success) {
            // Show success message
            showToast('success', 'Item added to cart successfully!');
            
            // Update cart badge if exists
            const cartBadge = document.querySelector('.cart-badge');
            if (cartBadge && data.cart_count) {
                cartBadge.textContent = data.cart_count;
                cartBadge.style.display = 'inline';
            }
        } else {
            showToast('error', data.message || 'Failed to add item to cart');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.innerHTML = originalText;
        button.disabled = false;
        showToast('error', 'An error occurred while adding item to cart');
    });
}

function showToast(type, message) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}

// Responsive filter sidebar
window.addEventListener('resize', function() {
    const filterSidebar = document.getElementById('filterSidebar');
    if (window.innerWidth >= 992) {
        filterSidebar.style.display = 'block';
        filterSidebar.classList.remove('mobile-filter-show');
    } else {
        if (!filterSidebar.classList.contains('mobile-filter-show')) {
            filterSidebar.style.display = 'none';
        }
    }
});
</script>

<style>
/* Additional CSS for mobile filter sidebar */
@media (max-width: 991.98px) {
    #filterSidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 1050;
        overflow-y: auto;
        width: 300px;
        display: none;
    }
    
    #filterSidebar.mobile-filter-show {
        display: block !important;
    }
    
    #filterSidebar::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: -1;
    }
}

.cursor-pointer {
    cursor: pointer;
}

.filter-section {
    border-bottom: 1px solid #eee;
    padding-bottom: 1rem;
}

.filter-section:last-child {
    border-bottom: none;
}

.filter-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 1rem;
}

.form-check-label {
    font-size: 0.9rem;
    color: #555;
}

.food-item {
    transition: all 0.3s ease;
}

.food-item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.75rem;
}
</style>

{% endblock %}
