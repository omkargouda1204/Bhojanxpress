{% extends "base.html" %}

{% block title %}Order #{{ order.id }} Details - BhojanXpress{% endblock %}

{% block contact_buttons %}
    <!-- Contact Support Button -->
    <div class="contact-support-float">
        <button class="btn btn-primary contact-support-btn" onclick="openContactModal()" title="Contact Support">
            <i class="fas fa-headset"></i> Support
        </button>
    </div>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-receipt"></i> Order #{{ order.id }}</h2>
            <p class="text-muted">Placed on {{ order.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
        </div>
        <a href="{{ url_for('user.my_orders') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left"></i> Back to Orders
        </a>
    </div>
    
    <div class="row">
        <!-- Order Items -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Order Items</h5>
                </div>
                <div class="card-body">
                    {% for item in order.order_items %}
                    <div class="card mb-3 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2 col-3 text-center">
                                    <!-- Item image if available, otherwise placeholder -->
                                    {% if item.food_item and item.food_item.image_url %}
                                    <img src="{{ item.food_item.image_url }}" alt="{{ item.food_item.name }}" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-light rounded p-2 text-center">
                                        <i class="fas fa-utensils fa-2x text-muted"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-7 col-9">
                                    <div class="d-flex align-items-center mb-1">
                                        <span class="badge bg-primary me-2">{{ item.quantity }}x</span>
                                        <h6 class="mb-0 fw-bold">{{ item.food_item.name if item.food_item else 'Item Unavailable' }}</h6>
                                    </div>

                                    <!-- Enhanced item details -->
                                    <div class="mt-2 small">
                                        {% if item.food_item %}
                                            <div class="text-muted mb-1">
                                                <span class="badge bg-light text-dark me-2">{{ item.food_item.category_rel.display_name if item.food_item.category_rel else item.food_item.category }}</span>
                                                {% if item.food_item.preparation_time %}
                                                <span class="me-2"><i class="far fa-clock me-1"></i>{{ item.food_item.preparation_time }} min</span>
                                                {% endif %}
                                            </div>
                                            {% if item.food_item.description %}
                                            <p class="text-muted small mb-0 text-truncate" style="max-width: 350px;">{{ item.food_item.description }}</p>
                                            {% endif %}
                                        {% else %}
                                            <p class="text-danger small">This item is no longer available in the menu</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-3 mt-3 mt-md-0">
                                    <div class="text-end">
                                        <div class="text-muted small">₹{{ "%.2f"|format(item.price) }} each</div>
                                        <div class="h6 mb-0 mt-1 fw-bold">₹{{ "%.2f"|format(item.quantity * item.price) }}</div>
                                    </div>
                                </div>
                            </div>

                            {% if item.food_item and item.food_item.is_available == False %}
                            <div class="mt-2 pt-2 border-top">
                                <div class="small text-warning">
                                    <i class="fas fa-info-circle me-1"></i> This item is currently unavailable in the menu.
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Delivery Information -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-truck"></i> Delivery Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-user"></i> Customer Details</h6>
                            <p class="mb-1"><strong>Name:</strong> {{ order.customer_name or (order.user.username if order.user else '') }}</p>
                            <p class="mb-1"><strong>Phone:</strong> {{ order.phone_number or (order.user.phone if order.user else 'Not provided') }}</p>
                            <p class="mb-1"><strong>Email:</strong> {{ order.user.email if order.user else 'Not provided' }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-map-marker-alt"></i> Delivery Address</h6>
                            <p class="mb-0">{{ order.delivery_address or 'No address provided' }}</p>
                            {% if order.special_instructions %}
                                <hr>
                                <h6><i class="fas fa-sticky-note"></i> Special Instructions</h6>
                                <p class="mb-0 text-muted">{{ order.special_instructions }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary and Status -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-receipt"></i> Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>₹{{ "%.2f"|format(order.subtotal or 0) }}</span>
                    </div>

                    {% if order.discount_amount and order.discount_amount > 0 %}
                    <div class="d-flex justify-content-between mb-2 text-success">
                        <span>Discount:</span>
                        <span>-₹{{ "%.2f"|format(order.discount_amount) }}</span>
                    </div>
                    {% endif %}

                    {% if order.coupon_discount and order.coupon_discount > 0 %}
                    <div class="d-flex justify-content-between mb-2 text-info">
                        <span>Coupon Discount:</span>
                        <span>-₹{{ "%.2f"|format(order.coupon_discount) }}</span>
                    </div>
                    {% endif %}

                    <div class="d-flex justify-content-between mb-2">
                        <span>GST (5%):</span>
                        <span>₹{{ "%.2f"|format(order.gst_amount or 0) }}</span>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Delivery Charges:</span>
                        <span>
                            {% if order.delivery_charge == 0 %}
                                <span class="text-success">FREE</span>
                            {% else %}
                                ₹{{ "%.2f"|format(order.delivery_charge or 0) }}
                            {% endif %}
                        </span>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between fw-bold h5">
                        <span>Total Amount:</span>
                        <span class="text-success">₹{{ "%.2f"|format(order.total_amount) }}</span>
                    </div>

                    <div class="mt-3 p-3 bg-light rounded">
                        <h6><i class="fas fa-credit-card"></i> Payment Method</h6>
                        <span class="badge bg-info">
                            {{ order.payment_method|replace('_', ' ')|title }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Order Status -->
            <div class="card">
                <div class="card-header
                    {% if order.status == 'pending' %}bg-warning{% endif %}
                    {% if order.status == 'confirmed' %}bg-info{% endif %}
                    {% if order.status == 'preparing' %}bg-primary{% endif %}
                    {% if order.status == 'out_for_delivery' %}bg-secondary{% endif %}
                    {% if order.status == 'delivered' %}bg-success{% endif %}
                    {% if order.status == 'cancelled' %}bg-danger{% endif %}
                    text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i>
                        Order Status: {{ order.status|replace('_', ' ')|title }}
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Status Timeline -->
                    <div class="timeline">
                        <div class="timeline-item {{ 'active' if order.status in ['pending', 'confirmed', 'preparing', 'out_for_delivery', 'delivered'] else '' }}">
                            <div class="timeline-marker {{ 'bg-success' if order.status in ['confirmed', 'preparing', 'out_for_delivery', 'delivered'] else 'bg-warning' }}">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="timeline-content">
                                <h6>Order Placed</h6>
                                <small class="text-muted">{{ order.created_at.strftime('%I:%M %p') }}</small>
                            </div>
                        </div>

                        <div class="timeline-item {{ 'active' if order.status in ['confirmed', 'preparing', 'out_for_delivery', 'delivered'] else '' }}">
                            <div class="timeline-marker {{ 'bg-success' if order.status in ['confirmed', 'preparing', 'out_for_delivery', 'delivered'] else 'bg-secondary' }}">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="timeline-content">
                                <h6>Order Confirmed</h6>
                                <small class="text-muted">
                                    {% if order.status in ['confirmed', 'preparing', 'out_for_delivery', 'delivered'] %}
                                        {{ (order.created_at + timedelta(minutes=5)).strftime('%I:%M %p') }}
                                    {% else %}
                                        Pending
                                    {% endif %}
                                </small>
                            </div>
                        </div>

                        <div class="timeline-item {{ 'active' if order.status in ['preparing', 'out_for_delivery', 'delivered'] else '' }}">
                            <div class="timeline-marker {{ 'bg-success' if order.status in ['preparing', 'out_for_delivery', 'delivered'] else 'bg-secondary' }}">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <div class="timeline-content">
                                <h6>Preparing</h6>
                                <small class="text-muted">
                                    {% if order.status in ['preparing', 'out_for_delivery', 'delivered'] %}
                                        {{ (order.created_at + timedelta(minutes=15)).strftime('%I:%M %p') }}
                                    {% else %}
                                        Pending
                                    {% endif %}
                                </small>
                            </div>
                        </div>

                        <div class="timeline-item {{ 'active' if order.status in ['out_for_delivery', 'delivered'] else '' }}">
                            <div class="timeline-marker {{ 'bg-success' if order.status in ['out_for_delivery', 'delivered'] else 'bg-secondary' }}">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="timeline-content">
                                <h6>Out for Delivery</h6>
                                <small class="text-muted">
                                    {% if order.status in ['out_for_delivery', 'delivered'] %}
                                        {{ (order.created_at + timedelta(minutes=35)).strftime('%I:%M %p') }}
                                    {% else %}
                                        Pending
                                    {% endif %}
                                </small>
                            </div>
                        </div>

                        <div class="timeline-item {{ 'active' if order.status == 'delivered' else '' }}">
                            <div class="timeline-marker {{ 'bg-success' if order.status == 'delivered' else 'bg-secondary' }}">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="timeline-content">
                                <h6>Delivered</h6>
                                <small class="text-muted">
                                    {% if order.status == 'delivered' %}
                                        {{ order.created_at.strftime('%I:%M %p') }}
                                    {% else %}
                                        Estimated: {{ order.created_at.strftime('%I:%M %p') }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-3 d-grid gap-2">
                        {% if order.status in ['pending', 'confirmed'] %}
                            <button id="cancelBtn" class="btn btn-danger" onclick="cancelOrder({{ order.id }})">
                                <i class="fas fa-times"></i> Cancel Order
                            </button>
                            <small id="cancelTimer" class="text-muted">
                                <i class="fas fa-clock"></i> 
                                <span id="timeRemaining">Calculating...</span>
                            </small>
                        {% endif %}


                        <a href="{{ url_for('user.receipt', order_id=order.id, download=1) }}" class="btn btn-outline-primary">
                            <i class="fas fa-download"></i> Download Invoice
                        </a>

                        <button class="btn btn-outline-info" onclick="window.location.href='tel:+918431729319'">
                            <i class="fas fa-phone"></i> Contact Support
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-item:before {
    content: '';
    position: absolute;
    left: -22px;
    top: 15px;
    height: 100%;
    width: 2px;
    background-color: #dee2e6;
}

.timeline-item:last-child:before {
    display: none;
}

.timeline-marker {
    position: absolute;
    left: -30px;
    top: 0;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 10px;
}

.timeline-content h6 {
    margin-bottom: 2px;
    font-size: 14px;
}

.timeline-item.active .timeline-content h6 {
    color: #198754;
    font-weight: bold;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 5-minute cancellation timer
    const orderCreatedAt = new Date('{{ order.created_at.isoformat() }}');
    const cancelBtn = document.getElementById('cancelBtn');
    const timeRemaining = document.getElementById('timeRemaining');
    const cancelTimer = document.getElementById('cancelTimer');
    
    if (cancelBtn && timeRemaining) {
        function updateTimer() {
            const now = new Date();
            const timeDiff = now - orderCreatedAt;
            const minutesElapsed = timeDiff / (1000 * 60);
            const minutesRemaining = Math.max(0, 5 - minutesElapsed);
            
            if (minutesRemaining > 0) {
                const minutes = Math.floor(minutesRemaining);
                const seconds = Math.floor((minutesRemaining - minutes) * 60);
                timeRemaining.textContent = `Cancellation allowed for ${minutes}:${seconds.toString().padStart(2, '0')} more minutes`;
                cancelBtn.disabled = false;
                cancelBtn.className = 'btn btn-danger';
            } else {
                timeRemaining.textContent = 'Cancellation time expired (5 minutes)';
                cancelBtn.disabled = true;
                cancelBtn.className = 'btn btn-secondary';
                cancelTimer.className = 'text-danger';
            }
        }
        
        updateTimer();
        setInterval(updateTimer, 1000);
    }
});

function cancelOrder(orderId) {
    if (confirm('Are you sure you want to cancel this order?')) {
        // Create form data with CSRF token
        const formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token() }}');

        fetch(`/user/cancel-order/${orderId}`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Order cancelled successfully!');
                location.reload();
            } else {
                alert('Failed to cancel order: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to cancel order. Please try again.');
        });
    }
}
</script>
{% endblock %}
