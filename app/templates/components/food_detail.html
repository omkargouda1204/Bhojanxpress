{% extends "base.html" %}

{% block title %}{{ food.name }} - BhojanXpress{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <!-- Breadcrumbs -->
        <div class="col-12 mb-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('user.home') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('user.menu') }}">Menu</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('user.menu', category=food.category) }}">{{ food.category|capitalize }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ food.name }}</li>
                </ol>
            </nav>
        </div>

        <!-- Food Details Section -->
        <div class="col-lg-5 mb-4">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <!-- Food Image -->
                <div class="food-image-container">
                    {% if food.image_url %}
                    <img src="{{ food.image_url }}" alt="{{ food.name }}" class="card-img-top img-fluid" style="height: 350px; object-fit: cover;">
                    {% elif food.image_data %}
                    <img src="data:image/jpeg;base64,{{ food.image_data|b64encode }}" alt="{{ food.name }}" class="card-img-top img-fluid" style="height: 350px; object-fit: cover;">
                    {% else %}
                    <div class="bg-light d-flex align-items-center justify-content-center" style="height: 350px;">
                        <i class="fas fa-utensils fa-3x text-secondary"></i>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Food Information -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body d-flex flex-column h-100">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="card-title display-6 fw-bold mb-0">{{ food.name }}</h1>
                            <p class="text-muted mb-2">
                                <i class="fas fa-utensils me-1"></i> {{ food.category|capitalize if food.category else 'General' }}
                            </p>
                        </div>
                        <span class="badge {% if food.is_available %}bg-success{% else %}bg-danger{% endif %} fs-6 p-2">
                            {% if food.is_available %}Available{% else %}Sold Out{% endif %}
                        </span>
                    </div>

                    <h4 class="text-primary fw-bold mb-3">â‚¹{{ "%.2f"|format(food.price) }}</h4>

                    <div class="mb-4">
                        <h5 class="fw-bold">Description</h5>
                        <p class="card-text">{{ food.description }}</p>
                    </div>

                    {% if food.preparation_time %}
                    <div class="mb-4">
                        <h5 class="fw-bold">Preparation Time</h5>
                        <p>
                            <i class="fas fa-clock text-muted"></i>
                            Approximately {{ food.preparation_time }} minutes
                        </p>
                    </div>
                    {% endif %}

                    <!-- Add to Cart Section -->
                    <div class="mt-auto">
                        {% if food.is_available %}
                        <div class="d-flex align-items-center">
                            <div class="quantity-selector me-3">
                                <label for="quantity" class="form-label fw-bold">Quantity</label>
                                <div class="input-group">
                                    <button type="button" class="btn btn-outline-secondary" id="decrease-quantity">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="form-control text-center" id="quantity" value="1" min="1" max="10">
                                    <button type="button" class="btn btn-outline-secondary" id="increase-quantity">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <button id="add-to-cart-btn" class="btn btn-warning btn-lg px-4"
                                        onclick="addToCart({{ food.id }}, '{{ food.name }}', {{ food.price }}, document.getElementById('quantity').value)">
                                    <i class="fas fa-shopping-cart me-2"></i> Add to Cart
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <button class="btn btn-secondary btn-lg px-4" disabled>
                            <i class="fas fa-shopping-cart me-2"></i> Currently Unavailable
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs for Reviews and Additional Info -->
    <div class="row mt-5">
        <div class="col-12">
            <ul class="nav nav-tabs" id="foodDetailsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab" aria-controls="reviews" aria-selected="true">
                        <i class="fas fa-star me-1"></i> Reviews ({{ ratings|length }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="nutrition-tab" data-bs-toggle="tab" data-bs-target="#nutrition" type="button" role="tab" aria-controls="nutrition" aria-selected="false">
                        <i class="fas fa-chart-pie me-1"></i> Nutrition
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ingredients-tab" data-bs-toggle="tab" data-bs-target="#ingredients" type="button" role="tab" aria-controls="ingredients" aria-selected="false">
                        <i class="fas fa-list me-1"></i> Ingredients
                    </button>
                </li>
            </ul>

            <div class="tab-content p-4 border border-top-0 rounded-bottom" id="foodDetailsTabsContent">
                <!-- Reviews Tab -->
                <div class="tab-pane fade show active" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                    <!-- Submit Review Form -->
                    {% if current_user.is_authenticated %}
                    <div class="card mb-4 border-0 bg-light">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="fas fa-star text-warning me-2"></i>
                                <span id="reviewFormTitle">Write a Review</span>
                            </h5>
                            <form method="POST" action="{{ url_for('reviews.submit_review') }}" enctype="multipart/form-data" id="reviewForm">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="food_item_id" value="{{ food.id }}">
                                <input type="hidden" id="editReviewId" name="edit_review_id" value="">
                                
                                <!-- Rating Stars -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Your Rating</label>
                                    <div class="rating-input d-flex align-items-center">
                                        <div class="star-rating me-3">
                                            {% for i in range(5, 0, -1) %}
                                            <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required>
                                            <label for="star{{ i }}" class="star-label">
                                                <i class="fas fa-star"></i>
                                            </label>
                                            {% endfor %}
                                        </div>
                                        <span id="ratingText" class="text-muted small">Click to rate</span>
                                    </div>
                                </div>

                                <!-- Review Comment -->
                                <div class="mb-3">
                                    <label for="comment" class="form-label fw-bold">Your Review</label>
                                    <textarea class="form-control" id="comment" name="comment" rows="4" 
                                            placeholder="Tell others about your experience with this dish..."></textarea>
                                    <div class="form-text">Share details about taste, quality, presentation, or anything else customers would find helpful.</div>
                                </div>

                                <!-- Review Images Upload -->
                                <div class="mb-3">
                                    <label for="reviewImages" class="form-label fw-bold">
                                        <i class="fas fa-camera me-1"></i> Add Photos (Optional)
                                    </label>
                                    <input type="file" class="form-control" id="reviewImages" name="images" 
                                           multiple accept="image/*" onchange="previewReviewImages()">
                                    <div class="form-text">Upload up to 3 photos of your dish. JPG, PNG accepted. Max 2MB each.</div>
                                    
                                    <!-- Image Preview -->
                                    <div id="imagePreview" class="mt-3 d-none">
                                        <div class="row g-2" id="previewContainer"></div>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary px-4" id="submitReviewBtn">
                                        <i class="fas fa-paper-plane me-2"></i>
                                        <span id="submitBtnText">Submit Review</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="cancelEditBtn" onclick="cancelEdit()" style="display: none;">
                                        <i class="fas fa-times me-1"></i> Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Want to leave a review?</strong> 
                        <a href="{{ url_for('auth.login', next=url_for('user.food_detail', food_id=food.id)) }}" class="alert-link">Log in</a> 
                        to share your experience with this item.
                    </div>
                    {% endif %}

                    <!-- Rating Statistics -->
                    <div class="row mb-4">
                        <div class="col-lg-4">
                            <div class="text-center py-4 bg-light rounded-3">
                                <div class="rating-summary">
                                    <h1 class="display-2 fw-bold text-primary mb-0">{{ "%.1f"|format(avg_rating) }}</h1>
                                    <div class="rating-stars mb-2 fs-5">
                                        {% for i in range(5) %}
                                            {% if i < avg_rating|int %}
                                                <i class="fas fa-star text-warning"></i>
                                            {% elif (i < avg_rating|round(0, 'ceil')) and ((avg_rating - i) >= 0.5) %}
                                                <i class="fas fa-star-half-alt text-warning"></i>
                                            {% else %}
                                                <i class="far fa-star text-warning"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <p class="text-muted mb-0">Based on {{ ratings|length }} 
                                        {% if ratings|length == 1 %}review{% else %}reviews{% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <h6 class="mb-3">Rating Distribution</h6>
                            <div class="rating-distribution">
                                {% for i in range(5, 0, -1) %}
                                {% set count = ratings|selectattr('rating', 'equalto', i)|list|length %}
                                {% set percentage = (count / ratings|length * 100)|int if ratings|length > 0 else 0 %}
                                <div class="d-flex align-items-center mb-2">
                                    <div class="d-flex align-items-center me-3" style="width: 80px;">
                                        <span class="me-1">{{ i }}</span>
                                        <i class="fas fa-star text-warning fa-sm"></i>
                                    </div>
                                    <div class="progress flex-grow-1" style="height: 10px;">
                                        <div class="progress-bar bg-warning" role="progressbar"
                                             style="width: {{ percentage }}%;"
                                             aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <div class="ms-3 text-muted small" style="width: 50px;">
                                        {{ count }} {% if count == 1 %}review{% else %}reviews{% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Review Filters -->
                    {% if ratings|length > 1 %}
                    <div class="review-filters mb-4">
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <span class="fw-bold me-2">Filter by:</span>
                            <button class="btn btn-sm btn-outline-primary active" onclick="filterReviews('all')">All Reviews</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="filterReviews(5)">5 Stars</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="filterReviews(4)">4 Stars</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="filterReviews(3)">3 Stars</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="filterReviews(2)">2 Stars</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="filterReviews(1)">1 Star</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="filterReviews('with-photos')">
                                <i class="fas fa-camera me-1"></i> With Photos
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- User Reviews List -->
                    <div class="user-reviews">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-comments me-2"></i>
                                Customer Reviews
                                <span class="badge bg-primary ms-2">{{ ratings|length }}</span>
                            </h5>
                            {% if ratings|length > 1 %}
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-sort me-1"></i> Sort by
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="sortReviews('newest')">Newest First</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="sortReviews('oldest')">Oldest First</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="sortReviews('highest')">Highest Rated</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="sortReviews('lowest')">Lowest Rated</a></li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div id="reviewsList">
                            {% if ratings %}
                                {% for rating in ratings %}
                                <div class="review-item card mb-3 border-0 shadow-sm" data-rating="{{ rating.rating }}" data-date="{{ rating.created_at.isoformat() }}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div class="d-flex align-items-center">
                                                <!-- User Avatar -->
                                                <div class="user-avatar me-3">
                                                    {% if rating.user and rating.user.profile_image %}
                                                    <img src="{{ rating.user.profile_image }}" alt="User" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                                    {% else %}
                                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white fw-bold" style="width: 50px; height: 50px;">
                                                        {% if rating.user and rating.user.username %}
                                                        {{ rating.user.username[0]|upper }}
                                                        {% else %}
                                                        ?
                                                        {% endif %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                
                                                <!-- User Info -->
                                                <div>
                                                    <h6 class="mb-1 fw-bold">
                                                        {% if rating.user and rating.user.username %}
                                                        {{ rating.user.username }}
                                                        {% if rating.user.first_name and rating.user.last_name %}
                                                        <span class="text-muted fw-normal">({{ rating.user.first_name }} {{ rating.user.last_name }})</span>
                                                        {% endif %}
                                                        {% else %}
                                                        Anonymous User
                                                        {% endif %}
                                                    </h6>
                                                    <div class="rating-stars mb-1">
                                                        {% for i in range(5) %}
                                                        <i class="{% if i < rating.rating %}fas{% else %}far{% endif %} fa-star text-warning"></i>
                                                        {% endfor %}
                                                    </div>
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        {{ rating.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                                        {% if rating.updated_at and rating.updated_at != rating.created_at %}
                                                        <span class="badge bg-info ms-2">Edited</span>
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            </div>

                                            <!-- Review Actions -->
                                            {% if current_user.is_authenticated and rating.user_id == current_user.id %}
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                        data-bs-toggle="dropdown" aria-expanded="false">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="editReview({{ rating.id }})">
                                                        <i class="fas fa-edit me-2"></i> Edit Review
                                                    </a></li>
                                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteReview({{ rating.id }})">
                                                        <i class="fas fa-trash me-2"></i> Delete Review
                                                    </a></li>
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <!-- Review Content -->
                                        {% if rating.comment %}
                                        <div class="review-comment mb-3">
                                            <p class="mb-0">{{ rating.comment }}</p>
                                        </div>
                                        {% endif %}

                                        <!-- Review Images -->
                                        {% if rating.images %}
                                        <div class="review-images mb-3">
                                            <div class="row g-2">
                                                {% for image in rating.images %}
                                                <div class="col-auto">
                                                    <img src="{{ image.image_url }}" alt="Review Image" 
                                                         class="img-thumbnail review-image-thumb" 
                                                         style="width: 100px; height: 100px; object-fit: cover; cursor: pointer;"
                                                         onclick="viewImageModal('{{ image.image_url }}', '{{ rating.user.username if rating.user else 'Anonymous' }}')">
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Admin Reply to Review -->
                                        {% if rating.admin_reply %}
                                        <div class="admin-reply mt-3 mb-3 border-start border-3 border-primary ps-3">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white me-2" style="width: 30px; height: 30px;">
                                                    <i class="fas fa-user-shield"></i>
                                                </div>
                                                <div>
                                                    <span class="fw-bold text-primary">Admin Reply</span>
                                                    {% if rating.admin_reply_at %}
                                                    <small class="text-muted ms-2">
                                                        <i class="fas fa-clock"></i>
                                                        {{ rating.admin_reply_at.strftime('%B %d, %Y at %I:%M %p') }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <p class="mb-0">{{ rating.admin_reply }}</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-comments fa-4x mb-3 text-muted"></i>
                                    <h6>No Reviews Yet</h6>
                                    <p>Be the first to share your experience with this dish!</p>
                                    {% if current_user.is_authenticated %}
                                    <button class="btn btn-primary mt-2" onclick="document.getElementById('comment').focus()">
                                        <i class="fas fa-star me-2"></i> Write First Review
                                    </button>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Load More Reviews Button -->
                        {% if ratings|length > 5 %}
                        <div class="text-center mt-4">
                            <button id="loadMoreReviews" class="btn btn-outline-primary" onclick="loadMoreReviews()">
                                <i class="fas fa-chevron-down me-2"></i> Load More Reviews
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Nutrition Tab -->
                <div class="tab-pane fade" id="nutrition" role="tabpanel" aria-labelledby="nutrition-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mb-3">Nutritional Information</h5>
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <th>Calories</th>
                                        <td>
                                            {% if food.nutritional_info and food.nutritional_info.calories %}
                                                {{ food.nutritional_info.calories }}
                                            {% else %}
                                                Not available
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Protein</th>
                                        <td>
                                            {% if food.nutritional_info and food.nutritional_info.protein %}
                                                {{ food.nutritional_info.protein }}g
                                            {% else %}
                                                Not available
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Carbohydrates</th>
                                        <td>
                                            {% if food.nutritional_info and food.nutritional_info.carbohydrates %}
                                                {{ food.nutritional_info.carbohydrates }}g
                                            {% else %}
                                                Not available
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Fat</th>
                                        <td>
                                            {% if food.nutritional_info and food.nutritional_info.fat %}
                                                {{ food.nutritional_info.fat }}g
                                            {% else %}
                                                Not available
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Sugar</th>
                                        <td>
                                            {% if food.nutritional_info and food.nutritional_info.sugar_g is not none %}
                                                {{ food.nutritional_info.sugar_g }}g
                                            {% else %}
                                                Not available
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="text-muted small">Values are approximate and may vary.</p>
                        </div>
                        <div class="col-md-6">
                            <h5 class="mb-3">Dietary Information</h5>
                            <div class="d-flex flex-wrap">
                                {% set dietary_tags = [
                                    {'name': 'Vegetarian', 'icon': 'leaf', 'value': food.is_vegetarian},
                                    {'name': 'Vegan', 'icon': 'seedling', 'value': food.is_vegan},
                                    {'name': 'Gluten Free', 'icon': 'bread-slice', 'value': food.is_gluten_free},
                                    {'name': 'Contains Nuts', 'icon': 'asterisk', 'value': food.contains_nuts}
                                ] %}

                                {% for tag in dietary_tags %}
                                    <div class="badge {{ 'bg-success' if tag.value else 'bg-secondary' }} p-2 m-1">
                                        <i class="fas fa-{{ tag.icon }} me-1"></i> {{ tag.name }}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ingredients Tab -->
                <div class="tab-pane fade" id="ingredients" role="tabpanel" aria-labelledby="ingredients-tab">
                    <h5 class="mb-3">Ingredients</h5>
                    <p>
                        {% if food.nutritional_info and food.nutritional_info.ingredients %}
                            {{ food.nutritional_info.ingredients }}
                        {% else %}
                            Ingredients information not available.
                        {% endif %}
                    </p>
                    
                    {% if food.nutritional_info and food.nutritional_info.allergens %}
                    <div class="mt-4">
                        <h6 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Allergens</h6>
                        <p class="text-muted">{{ food.nutritional_info.allergens }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Similar Items Section -->
    {% if similar_items %}
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-4">You May Also Like</h3>
            <div class="row g-4">
                {% for item in similar_items %}
                <div class="col-md-6 col-lg-3">
                    <div class="card h-100 food-card border-0 shadow-sm rounded-4 overflow-hidden">
                        <!-- Make the image clickable -->
                        <a href="{{ url_for('user.food_detail', food_id=item.id) }}" class="position-relative">
                            {% if item.image_url %}
                            <img src="{{ item.image_url }}" alt="{{ item.name }}" class="card-img-top food-img" style="height: 180px; object-fit: cover;">
                            {% elif item.image_path %}
                            <img src="{{ url_for('static', filename=item.image_path) }}" alt="{{ item.name }}" class="card-img-top food-img" style="height: 180px; object-fit: cover;">
                            {% else %}
                            <div class="bg-light d-flex align-items-center justify-content-center" style="height: 180px;">
                                <i class="fas fa-utensils fa-2x text-secondary"></i>
                            </div>
                            {% endif %}

                            <span class="badge rounded-pill position-absolute top-0 end-0 m-3 {% if item.is_available %}bg-success{% else %}bg-danger{% endif %}">
                                {% if item.is_available %}Available{% else %}Sold Out{% endif %}
                            </span>
                        </a>

                        <div class="card-body d-flex flex-column">
                            <!-- Make the title clickable -->
                            <a href="{{ url_for('user.food_detail', food_id=item.id) }}" class="text-decoration-none text-dark">
                                <h5 class="card-title mb-2">{{ item.name }}</h5>
                            </a>
                            <div class="d-flex justify-content-between align-items-center mt-auto">
                                <span class="fw-bold text-primary">â‚¹{{ "%.2f"|format(item.price) }}</span>
                                <!-- Add Cart Button -->
                                {% if item.is_available %}
                                <button onclick="addToCart({{ item.id }}, '{{ item.name }}', {{ item.price }})" class="btn btn-warning">
                                    <i class="fas fa-shopping-cart"></i> Add
                                </button>
                                {% else %}
                                <button class="btn btn-secondary" disabled>
                                    <i class="fas fa-shopping-cart"></i> Sold Out
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Rating stars styling for display */
    .rating-stars {
        font-size: 1.2rem;
    }

    /* Rating stars styling for input */
    .rating-input {
        display: inline-flex;
        flex-direction: row-reverse;
        border-radius: 0.25rem;
    }

    .rating-input input {
        display: none;
    }

    .rating-input label {
        cursor: pointer;
        font-size: 1.5rem;
        color: #ddd;
        padding: 0 0.1rem;
    }

    .rating-input input:checked ~ label,
    .rating-input label:hover,
    .rating-input label:hover ~ label {
        color: #ffc107;
    }

    .rating-input input:checked + label:hover,
    .rating-input input:checked ~ label:hover,
    .rating-input input:checked ~ label:hover ~ label,
    .rating-input label:hover ~ input:checked ~ label {
        color: #ffdb70;
    }

    /* Food card hover effects */
    .food-card {
        transition: all 0.3s ease;
    }

    .food-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }

    .food-img {
        transition: all 0.5s ease;
    }

    .food-card:hover .food-img {
        transform: scale(1.05);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Quantity selector functionality
        const quantityInput = document.getElementById('quantity');
        const decreaseBtn = document.getElementById('decrease-quantity');
        const increaseBtn = document.getElementById('increase-quantity');

        if (decreaseBtn && increaseBtn && quantityInput) {
            decreaseBtn.addEventListener('click', function() {
                const currentValue = parseInt(quantityInput.value);
                if (currentValue > 1) {
                    quantityInput.value = currentValue - 1;
                }
            });

            increaseBtn.addEventListener('click', function() {
                const currentValue = parseInt(quantityInput.value);
                if (currentValue < 10) {
                    quantityInput.value = currentValue + 1;
                }
            });

            // Ensure quantity is always between 1-10
            quantityInput.addEventListener('change', function() {
                let val = parseInt(this.value);
                if (isNaN(val) || val < 1) {
                    this.value = 1;
                } else if (val > 10) {
                    this.value = 10;
                }
            });
        }

        // Rating stars interaction
        const ratingInputs = document.querySelectorAll('input[name="rating"]');
        const ratingText = document.getElementById('ratingText');
        const ratingTexts = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];

        ratingInputs.forEach(input => {
            input.addEventListener('change', function() {
                const rating = parseInt(this.value);
                if (ratingText) {
                    ratingText.textContent = ratingTexts[rating - 1];
                }
            });
        });

        // Initialize review display
        initializeReviewDisplay();
        
        // Handle review form submission
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) {
            reviewForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate form
                const rating = document.querySelector('input[name="rating"]:checked');
                const comment = document.getElementById('comment');
                
                if (!rating) {
                    showToast('Please select a rating', 'error');
                    return false;
                }
                
                if (!comment.value.trim() || comment.value.length < 5) {
                    showToast('Please write a review comment (minimum 5 characters)', 'error');
                    comment.focus();
                    return false;
                }
                
                // Submit both new and edit reviews to the same endpoint
                const editReviewId = document.getElementById('editReviewId').value;
                const url = '{{ url_for("reviews.submit_review") }}';
                const method = 'POST';
                
                // Create FormData from the form
                const formData = new FormData(reviewForm);
                
                // Submit the form via fetch
                fetch(url, {
                    method: method,
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message || 'Review submitted successfully!', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        showToast(data.message || 'Error submitting review', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred while submitting your review', 'error');
                });
            });
        }
    });

    // Enhanced Review System Functions

    // Image preview for review images
    function previewReviewImages() {
        const input = document.getElementById('reviewImages');
        const preview = document.getElementById('imagePreview');
        const container = document.getElementById('previewContainer');
        
        container.innerHTML = '';
        
        if (input.files && input.files.length > 0) {
            preview.classList.remove('d-none');
            
            // Limit to 3 images
            const filesToShow = Math.min(input.files.length, 3);
            
            for (let i = 0; i < filesToShow; i++) {
                const file = input.files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const col = document.createElement('div');
                    col.className = 'col-4';
                    col.innerHTML = `
                        <div class="position-relative">
                            <img src="${e.target.result}" class="img-thumbnail" style="width: 100%; height: 80px; object-fit: cover;">
                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 rounded-circle" 
                                    onclick="removePreviewImage(${i})" style="width: 25px; height: 25px; padding: 0;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(col);
                };
                
                reader.readAsDataURL(file);
            }
        } else {
            preview.classList.add('d-none');
        }
    }

    // Remove preview image
    function removePreviewImage(index) {
        const input = document.getElementById('reviewImages');
        const dt = new DataTransfer();
        
        for (let i = 0; i < input.files.length; i++) {
            if (i !== index) {
                dt.items.add(input.files[i]);
            }
        }
        
        input.files = dt.files;
        previewReviewImages();
    }

    // Filter reviews by rating
    function filterReviews(filter) {
        const reviews = document.querySelectorAll('.review-item');
        const filterButtons = document.querySelectorAll('.review-filters button');
        
        // Update active button
        filterButtons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        reviews.forEach(review => {
            const rating = parseInt(review.getAttribute('data-rating'));
            let show = false;
            
            if (filter === 'all') {
                show = true;
            } else if (filter === 'with-photos') {
                show = review.querySelector('.review-images') !== null;
            } else {
                show = rating === parseInt(filter);
            }
            
            review.style.display = show ? 'block' : 'none';
        });
    }

    // Sort reviews
    function sortReviews(sortBy) {
        const container = document.getElementById('reviewsList');
        const reviews = Array.from(container.querySelectorAll('.review-item'));
        
        reviews.sort((a, b) => {
            const ratingA = parseInt(a.getAttribute('data-rating'));
            const ratingB = parseInt(b.getAttribute('data-rating'));
            const dateA = new Date(a.getAttribute('data-date'));
            const dateB = new Date(b.getAttribute('data-date'));
            
            switch (sortBy) {
                case 'newest':
                    return dateB - dateA;
                case 'oldest':
                    return dateA - dateB;
                case 'highest':
                    return ratingB - ratingA;
                case 'lowest':
                    return ratingA - ratingB;
                default:
                    return dateB - dateA;
            }
        });
        
        // Clear container and re-append sorted reviews
        const firstChild = container.firstElementChild;
        while (container.firstElementChild && !container.firstElementChild.classList.contains('review-item')) {
            // Keep non-review elements at the top
            firstChild = container.firstElementChild.nextElementSibling;
        }
        
        // Remove all review items
        reviews.forEach(review => review.remove());
        
        // Add sorted reviews back
        reviews.forEach(review => container.appendChild(review));
        
        showToast(`Reviews sorted by ${sortBy}`, 'success');
    }

    // Delete review
    function deleteReview(reviewId) {
        if (confirm('Are you sure you want to delete this review? This action cannot be undone.')) {
            fetch(`/reviews/${reviewId}/delete`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Review deleted successfully', 'success');
                    location.reload(); // Refresh to update ratings
                } else {
                    showToast(data.message || 'Failed to delete review', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred while deleting the review', 'error');
            });
        }
    }

    // Edit review
    function editReview(reviewId) {
        // Fetch review data
        fetch(`/reviews/edit/${reviewId}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update form title
                document.getElementById('reviewFormTitle').textContent = 'Update Your Review';
                document.getElementById('submitBtnText').textContent = 'Update Review';
                document.getElementById('cancelEditBtn').style.display = 'block';
                
                // Fill form with existing data
                document.getElementById('editReviewId').value = reviewId;
                document.getElementById('comment').value = data.review.comment || '';
                
                // Set rating
                const ratingRadio = document.querySelector(`input[name="rating"][value="${data.review.rating}"]`);
                if (ratingRadio) {
                    ratingRadio.checked = true;
                    updateRatingText(data.review.rating);
                }
                
                // Scroll to form
                document.getElementById('reviewForm').scrollIntoView({ behavior: 'smooth' });
                
                showToast('Editing review - make your changes and click "Update Review"', 'info');
            } else {
                showToast(data.message || 'Failed to load review for editing', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred while loading the review', 'error');
        });
    }

    // Cancel edit
    function cancelEdit() {
        document.getElementById('reviewFormTitle').textContent = 'Write a Review';
        document.getElementById('submitBtnText').textContent = 'Submit Review';
        document.getElementById('cancelEditBtn').style.display = 'none';
        document.getElementById('editReviewId').value = '';
        
        // Clear form
        document.getElementById('reviewForm').reset();
        document.getElementById('ratingText').textContent = 'Click to rate';
        
        showToast('Edit cancelled', 'info');
    }

    // Update rating text
    function updateRatingText(rating) {
        const ratingTexts = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
        document.getElementById('ratingText').textContent = ratingTexts[rating - 1];
    }

    // View image in modal
    function viewImageModal(imageUrl, username) {
        // Create modal for image viewing
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Photo by ${username}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="${imageUrl}" class="img-fluid" alt="Review Image">
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
        
        modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
        });
    }

    // Load more reviews (if pagination is implemented)
    function loadMoreReviews() {
        // This would connect to a pagination endpoint
        showToast('Loading more reviews...', 'info');
        
        // Hide the button after loading
        document.getElementById('loadMoreReviews').style.display = 'none';
    }

    // Initialize review display
    function initializeReviewDisplay() {
        const reviews = document.querySelectorAll('.review-item');
        
        // Initially show only first 5 reviews
        reviews.forEach((review, index) => {
            if (index >= 5) {
                review.style.display = 'none';
            }
        });
    }

    // Add to cart function
    function addToCart(foodId, foodName, price, quantity) {
        const button = event.target;
        const originalText = button.innerHTML;
        
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Adding...';
        
        fetch(`/add_to_cart/${foodId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
            },
            body: new URLSearchParams({
                'quantity': quantity.toString()
            })
        })
        .then(response => response.json())
        .then(data => {
            button.disabled = false;
            button.innerHTML = originalText;
            
            if (data.success) {
                showToast(`${quantity}x ${foodName} added to cart!`, 'success');
                
                // Update cart count if element exists
                const cartBadge = document.querySelector('.cart-count-badge');
                if (cartBadge && data.cart_count) {
                    cartBadge.textContent = data.cart_count;
                    cartBadge.style.display = 'inline';
                }
            } else {
                showToast(data.message || 'Failed to add item to cart', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            button.disabled = false;
            button.innerHTML = originalText;
            showToast('An error occurred while adding item to cart', 'error');
        });
    }

    // Toast notification function
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px; animation: slideInRight 0.3s ease;';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }
</script>

<!-- Image Modal Template -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Review Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" class="img-fluid" alt="Review Image">
            </div>
        </div>
    </div>
</div>

<style>
    /* Enhanced Review System Styles */
    .star-rating {
        display: flex;
        flex-direction: row-reverse;
        gap: 0.2rem;
    }
    
    .star-rating input {
        display: none;
    }
    
    .star-label {
        font-size: 1.5rem;
        color: #ddd;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    
    .star-rating input:checked ~ .star-label,
    .star-rating input:checked ~ .star-label ~ .star-label {
        color: #ffc107;
    }
    
    .star-rating .star-label:hover,
    .star-rating .star-label:hover ~ .star-label {
        color: #ffc107;
    }
    
    .review-image-thumb {
        transition: transform 0.3s ease;
        border-radius: 8px;
    }
    
    .review-image-thumb:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .review-item {
        transition: all 0.3s ease;
    }
    
    .review-item:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
    }
    
    .user-avatar img,
    .user-avatar div {
        border: 2px solid #e9ecef;
    }
    
    .review-filters button.active {
        background-color: var(--bs-primary);
        color: white;
        border-color: var(--bs-primary);
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .rating-summary {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
    }
    
    .review-actions button {
        font-size: 0.85rem;
    }
</style>
{% endblock %}
