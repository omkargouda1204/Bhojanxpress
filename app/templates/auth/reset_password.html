{% extends "base.html" %}

{% block title %}Reset Password - BhojanXpress{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .reset-password-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        overflow: hidden;
        animation: slideUp 0.8s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .reset-password-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .reset-password-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
        animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .reset-password-header h2 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 700;
        position: relative;
        z-index: 2;
    }

    .reset-password-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
        font-size: 1.1rem;
        position: relative;
        z-index: 2;
    }

    .reset-password-form {
        padding: 2.5rem;
    }

    .otp-section {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        text-align: center;
    }

    .email-display {
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
    }

    .otp-input-group {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 1.5rem 0;
    }

    .otp-digit {
        width: 45px;
        height: 45px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        text-align: center;
        font-size: 1.2rem;
        font-weight: 600;
        background: #f8f9fa;
        transition: all 0.3s ease;
    }

    .otp-digit:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: white;
        outline: none;
    }

    .otp-digit.filled {
        border-color: #51cf66;
        background: rgba(81, 207, 102, 0.1);
    }

    .timer-display {
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid rgba(255, 107, 107, 0.2);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 0.9rem;
        font-weight: 600;
        color: #ff6b6b;
        display: inline-block;
        margin-top: 0.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-control {
        border: 2px solid #e1e5e9;
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: white;
        outline: none;
    }

    .password-input-group {
        position: relative;
    }

    .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #667eea;
        font-size: 1.1rem;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: color 0.3s ease;
    }

    .password-toggle:hover {
        color: #764ba2;
    }

    .password-requirements {
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 8px;
        padding: 12px;
        margin-top: 8px;
        font-size: 0.9rem;
    }

    .password-requirements ul {
        margin: 0;
        padding-left: 20px;
    }

    .password-requirements li {
        margin: 4px 0;
        color: #555;
    }

    .password-requirements li.valid {
        color: #51cf66;
    }

    .password-requirements li.invalid {
        color: #ff6b6b;
    }

    .password-match-indicator {
        margin-top: 8px;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .password-match-indicator.match {
        background: rgba(81, 207, 102, 0.1);
        border: 1px solid rgba(81, 207, 102, 0.2);
        color: #51cf66;
    }

    .password-match-indicator.no-match {
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid rgba(255, 107, 107, 0.2);
        color: #ff6b6b;
    }

    .btn-reset {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        width: 100%;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        margin: 1rem 0;
    }

    .btn-reset::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
        animation: shimmer 3s infinite linear;
    }

    .btn-reset:hover::before {
        opacity: 1;
    }

    .btn-reset:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-reset:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-resend {
        background: transparent;
        border: 2px solid #667eea;
        color: #667eea;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-top: 1rem;
    }

    .btn-resend:hover {
        background: #667eea;
        color: white;
        transform: translateY(-1px);
    }

    .btn-resend:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .back-link {
        text-align: center;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e1e5e9;
    }

    .back-link a {
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.3s ease;
    }

    .back-link a:hover {
        color: #764ba2;
        text-decoration: underline;
    }

    .alert {
        border: none;
        border-radius: 12px;
        padding: 12px 16px;
        margin-bottom: 1rem;
        font-weight: 500;
    }

    .alert-danger {
        background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        color: white;
    }

    .alert-success {
        background: linear-gradient(135deg, #51cf66, #40c057);
        color: white;
    }

    .alert-info {
        background: linear-gradient(135deg, #339af0, #228be6);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid vh-100 d-flex align-items-center justify-content-center py-4">
    <div class="col-md-6 col-lg-5">
        <div class="reset-password-container">
            <div class="reset-password-header">
                <h2>ðŸ”‘ Reset Password</h2>
                <p>Enter the OTP and create your new password</p>
            </div>
            
            <div class="reset-password-form">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <div class="otp-section">
                    <div class="email-display">
                        <i class="fas fa-envelope me-2"></i>
                        <strong>{{ email if email else 'your email' }}</strong>
                    </div>
                    
                    <p class="mb-3">Enter the 6-digit code we sent to your email:</p>
                    
                    <div class="otp-input-group">
                        <input type="text" class="otp-digit" id="digit1" maxlength="1" required>
                        <input type="text" class="otp-digit" id="digit2" maxlength="1" required>
                        <input type="text" class="otp-digit" id="digit3" maxlength="1" required>
                        <input type="text" class="otp-digit" id="digit4" maxlength="1" required>
                        <input type="text" class="otp-digit" id="digit5" maxlength="1" required>
                        <input type="text" class="otp-digit" id="digit6" maxlength="1" required>
                    </div>
                    
                    <div class="timer-display" id="timerDisplay">
                        <i class="fas fa-clock me-2"></i>
                        <span>Expires in: <strong><span id="countdown">10:00</span></strong></span>
                    </div>
                    
                    <button type="button" class="btn btn-resend" id="resendBtn">
                        <i class="fas fa-paper-plane me-2"></i>Resend OTP
                    </button>
                </div>

                <form method="POST" id="resetPasswordForm">
                    <input type="hidden" id="otp" name="otp" required>
                    
                    <div class="form-group">
                        <label for="new_password" class="form-label">New Password *</label>
                        <div class="password-input-group">
                            <input type="password" class="form-control" id="new_password" name="new_password" required
                                   placeholder="Enter your new password">
                            <button type="button" class="password-toggle" onclick="togglePassword('new_password', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-requirements">
                            <strong>Password Requirements:</strong>
                            <ul>
                                <li id="length-req">At least 8 characters long</li>
                                <li id="upper-req">At least one uppercase letter (A-Z)</li>
                                <li id="lower-req">At least one lowercase letter (a-z)</li>
                                <li id="number-req">At least one number (0-9)</li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirm_password" class="form-label">Confirm New Password *</label>
                        <div class="password-input-group">
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required
                                   placeholder="Confirm your new password">
                            <button type="button" class="password-toggle" onclick="togglePassword('confirm_password', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-match-indicator" id="passwordMatch" style="display: none;">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="matchText">Passwords match!</span>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-reset" id="resetBtn" disabled>
                        <i class="fas fa-key me-2"></i>Reset Password
                    </button>

                    <div class="back-link">
                        <p><a href="{{ url_for('auth.login') }}"><i class="fas fa-arrow-left me-1"></i> Back to Login</a></p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const otpInputs = document.querySelectorAll('.otp-digit');
    const otpHiddenInput = document.getElementById('otp');
    const form = document.getElementById('resetPasswordForm');
    const resetBtn = document.getElementById('resetBtn');
    const resendBtn = document.getElementById('resendBtn');
    const timerDisplay = document.getElementById('timerDisplay');
    const countdown = document.getElementById('countdown');
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const passwordMatch = document.getElementById('passwordMatch');
    const matchText = document.getElementById('matchText');
    
    let resendCooldown = 30; // 30 seconds cooldown for resend
    let otpExpiryTime = 600; // 10 minutes in seconds

    // Initialize OTP input handling
    otpInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
            const value = e.target.value;
            
            // Only allow digits
            if (!/^\d$/.test(value) && value !== '') {
                e.target.value = '';
                return;
            }

            // Update visual state
            if (value) {
                e.target.classList.add('filled');
                // Auto-move to next input
                if (index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            } else {
                e.target.classList.remove('filled');
            }

            updateOTPValue();
            updateFormValidation();
        });

        input.addEventListener('keydown', function(e) {
            // Handle backspace
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                otpInputs[index - 1].focus();
                otpInputs[index - 1].value = '';
                otpInputs[index - 1].classList.remove('filled');
                updateOTPValue();
                updateFormValidation();
            }
            
            // Handle arrow navigation
            if (e.key === 'ArrowLeft' && index > 0) {
                otpInputs[index - 1].focus();
            } else if (e.key === 'ArrowRight' && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
        });

        // Handle paste event
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const paste = e.clipboardData.getData('text').replace(/\D/g, '');
            
            if (paste.length === 6) {
                for (let i = 0; i < 6; i++) {
                    if (otpInputs[i]) {
                        otpInputs[i].value = paste[i];
                        otpInputs[i].classList.add('filled');
                    }
                }
                updateOTPValue();
                updateFormValidation();
                otpInputs[5].focus();
            }
        });
    });

    // Password validation
    newPasswordInput.addEventListener('input', function() {
        validatePassword(this.value);
        checkPasswordMatch();
        updateFormValidation();
    });

    confirmPasswordInput.addEventListener('input', function() {
        checkPasswordMatch();
        updateFormValidation();
    });

    function updateOTPValue() {
        const otp = Array.from(otpInputs).map(input => input.value).join('');
        otpHiddenInput.value = otp;
    }

    function validatePassword(password) {
        const requirements = {
            'length-req': password.length >= 8,
            'upper-req': /[A-Z]/.test(password),
            'lower-req': /[a-z]/.test(password),
            'number-req': /\d/.test(password)
        };

        for (const [id, isValid] of Object.entries(requirements)) {
            const element = document.getElementById(id);
            element.classList.remove('valid', 'invalid');
            element.classList.add(isValid ? 'valid' : 'invalid');
        }

        return Object.values(requirements).every(Boolean);
    }

    function checkPasswordMatch() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (confirmPassword) {
            const isMatch = newPassword === confirmPassword;
            passwordMatch.style.display = 'block';
            passwordMatch.classList.remove('match', 'no-match');
            
            if (isMatch) {
                passwordMatch.classList.add('match');
                matchText.innerHTML = '<i class="fas fa-check-circle me-2"></i>Passwords match!';
            } else {
                passwordMatch.classList.add('no-match');
                matchText.innerHTML = '<i class="fas fa-times-circle me-2"></i>Passwords do not match!';
            }
            
            return isMatch;
        } else {
            passwordMatch.style.display = 'none';
            return false;
        }
    }

    function updateFormValidation() {
        const otp = otpHiddenInput.value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        const isOtpValid = otp.length === 6;
        const isPasswordValid = validatePassword(newPassword);
        const isPasswordMatch = newPassword === confirmPassword && confirmPassword !== '';
        
        const isFormValid = isOtpValid && isPasswordValid && isPasswordMatch;
        resetBtn.disabled = !isFormValid;
    }

    // Form submission
    form.addEventListener('submit', function(e) {
        const otp = otpHiddenInput.value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (otp.length !== 6) {
            e.preventDefault();
            showMessage('Please enter all 6 digits of the OTP code.', 'error');
            return;
        }

        if (!validatePassword(newPassword)) {
            e.preventDefault();
            showMessage('Password does not meet the requirements.', 'error');
            return;
        }

        if (newPassword !== confirmPassword) {
            e.preventDefault();
            showMessage('Passwords do not match.', 'error');
            return;
        }

        // Show loading state
        resetBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Resetting Password...';
        resetBtn.disabled = true;
    });

    // Resend functionality
    resendBtn.addEventListener('click', function() {
        if (this.disabled) return;

        // Show loading state
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
        this.disabled = true;

        // Make AJAX request to resend OTP
        fetch('{{ url_for("otp.resend_reset_otp") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: '{{ email if email else "" }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('New OTP sent successfully!', 'success');
                
                // Clear current OTP inputs
                otpInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('filled');
                });
                otpHiddenInput.value = '';
                updateFormValidation();
                
                // Focus first input
                otpInputs[0].focus();
                
                // Start resend cooldown
                startResendCooldown();
                
                // Restart expiry timer
                startExpiryTimer();
            } else {
                showMessage(data.message || 'Failed to resend OTP. Please try again.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Network error. Please try again.', 'error');
        })
        .finally(() => {
            if (!this.disabled) {
                this.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Resend OTP';
            }
        });
    });

    function startResendCooldown() {
        let cooldownTime = resendCooldown;
        resendBtn.disabled = true;
        
        const cooldownInterval = setInterval(() => {
            if (cooldownTime > 0) {
                resendBtn.innerHTML = `<i class="fas fa-clock me-2"></i>Resend in ${cooldownTime}s`;
                cooldownTime--;
            } else {
                resendBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Resend OTP';
                resendBtn.disabled = false;
                clearInterval(cooldownInterval);
            }
        }, 1000);
    }

    function startExpiryTimer() {
        let timeLeft = otpExpiryTime;
        
        const timerInterval = setInterval(() => {
            if (timeLeft > 0) {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                countdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                timeLeft--;
            } else {
                countdown.textContent = '0:00';
                timerDisplay.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>OTP has expired! Please request a new code.</strong>';
                timerDisplay.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
                timerDisplay.style.borderColor = 'rgba(255, 107, 107, 0.2)';
                timerDisplay.style.color = '#ff6b6b';
                
                // Disable form
                resetBtn.disabled = true;
                otpInputs.forEach(input => input.disabled = true);
                
                clearInterval(timerInterval);
            }
        }, 1000);
    }

    function showMessage(message, type) {
        // Remove existing alerts
        document.querySelectorAll('.alert').forEach(alert => alert.remove());
        
        // Create new alert
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type}`;
        alertDiv.textContent = message;
        
        // Insert at the top of the form
        const form = document.querySelector('.reset-password-form');
        form.insertBefore(alertDiv, form.firstChild);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Initialize timers
    startExpiryTimer();
    
    // Focus first input on page load
    otpInputs[0].focus();
    
    // Initial validation
    updateFormValidation();
});

function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}
</script>
{% endblock %}